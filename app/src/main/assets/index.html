<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNES Emulator</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
        }
        canvas#game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated; /* Crucial para nitidez e performance */
        }
        /* Estilo do FPS */
        #fps-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00FF00;
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
    <script src="/assets/nostalgist.umd.js"></script>
</head>
<body>

<div id="fps-counter">FPS: 0</div>
<canvas id="game-canvas" tabindex="1"></canvas>

<script>
    let nostalgistInstance = null;
    let canvas = document.getElementById('game-canvas');

    // --- LÓGICA DE FPS ---
    const fpsElem = document.getElementById('fps-counter');
    let lastTime = performance.now();
    let frameCount = 0;

    function updateFPS() {
        const now = performance.now();
        frameCount++;
        if (now - lastTime >= 1000) {
            fpsElem.innerText = `FPS: ${frameCount}`;
            frameCount = 0;
            lastTime = now;
        }
        requestAnimationFrame(updateFPS);
    }
    requestAnimationFrame(updateFPS);

    // --- MAPA DE TECLAS OTIMIZADO ---
    // Mapeamento padrão do RetroArch Web (Snes9x)
    const keyMap = {
        'UP':    { code: 'ArrowUp',    key: 'ArrowUp',    keyCode: 38 },
        'DOWN':  { code: 'ArrowDown',  key: 'ArrowDown',  keyCode: 40 },
        'LEFT':  { code: 'ArrowLeft',  key: 'ArrowLeft',  keyCode: 37 },
        'RIGHT': { code: 'ArrowRight', key: 'ArrowRight', keyCode: 39 },
        'A':     { code: 'KeyX',       key: 'x',          keyCode: 88 }, // SNES A = Tecla X
        'B':     { code: 'KeyZ',       key: 'z',          keyCode: 90 }, // SNES B = Tecla Z
        'X':     { code: 'KeyS',       key: 's',          keyCode: 83 }, // SNES X = Tecla S
        'Y':     { code: 'KeyA',       key: 'a',          keyCode: 65 }, // SNES Y = Tecla A
        'START': { code: 'Enter',      key: 'Enter',      keyCode: 13 },
        'SELECT':{ code: 'ShiftRight', key: 'Shift',      keyCode: 16 }
    };

    // --- SIMULADOR DE INPUT ROBUSTO ---
    function androidButtonEvent(btnName, isDown) {
        const map = keyMap[btnName];
        if (!map) return;

        // Garante que o canvas tem foco para receber o input
        if (document.activeElement !== canvas) {
            canvas.focus();
        }

        const eventType = isDown ? 'keydown' : 'keyup';
        
        // Cria um evento completo para enganar o emulador
        const event = new KeyboardEvent(eventType, {
            bubbles: true,
            cancelable: true,
            view: window,
            key: map.key,
            code: map.code,
            keyCode: map.keyCode,
            which: map.keyCode,
            charCode: 0,
            location: 0,
            repeat: false
        });

        // Dispara no canvas e na janela (alguns cores ouvem window, outros canvas)
        canvas.dispatchEvent(event);
        window.dispatchEvent(event);
    }

    // --- INICIALIZAÇÃO DO JOGO ---
    async function launchGame(base64Rom, fileName) {
        try {
            if (nostalgistInstance) {
                await nostalgistInstance.exit();
            }

            // Decodificação rápida
            const binaryString = atob(base64Rom);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const romFile = new File([bytes], fileName);

            nostalgistInstance = await Nostalgist.launch({
                element: canvas,
                // DICA DE PERFORMANCE: Se estiver lento, tente mudar 'snes9x' para 'snes9x2005'
                // (requer que o arquivo snes9x2005_libretro.js/.wasm exista na pasta assets)
                core: 'snes9x', 
                rom: romFile,
                resolveCoreJs: (core) => `/assets/cores/${core}_libretro.js`,
                resolveCoreWasm: (core) => `/assets/cores/${core}_libretro.wasm`,
            });
            
            // Força foco após carregar
            setTimeout(() => canvas.focus(), 1000);

        } catch (e) {
            console.error(e);
            alert("Erro: " + e.message);
        }
    }
</script>
</body>
</html>
