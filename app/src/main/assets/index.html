<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNES Emulator</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas#game-canvas {
            display: block;
            width: 100%; 
            height: 100%;
            object-fit: contain; /* Mantém aspect ratio */
            image-rendering: pixelated; /* Performance visual */
        }
    </style>
    <!-- Nostalgist v0.19.1 - Local -->
    <script src="/assets/nostalgist.umd.js"></script>
</head>
<body>

<canvas id="game-canvas"></canvas>

<script>
    let nostalgistInstance = null;

    // Mapa de teclas virtuais para KeyCodes do teclado (Padrão RetroArch/Nostalgist)
    const keyMap = {
        'UP': 38,    // ArrowUp
        'DOWN': 40,  // ArrowDown
        'LEFT': 37,  // ArrowLeft
        'RIGHT': 39, // ArrowRight
        'A': 88,     // x
        'B': 90,     // z
        'X': 83,     // s
        'Y': 65,     // a
        'START': 13, // Enter
        'SELECT': 16 // Shift
    };

    // Função chamada pelo Android via Interface JS
    function androidButtonEvent(keyName, isDown) {
        const keyCode = keyMap[keyName];
        if (!keyCode) return;

        const eventName = isDown ? 'keydown' : 'keyup';
        const event = new KeyboardEvent(eventName, {
            bubbles: true, 
            cancelable: true, 
            keyCode: keyCode,
            which: keyCode,
            key: keyName // opcional, mas ajuda em debug
        });

        // Dispara no window e no canvas para garantir
        window.dispatchEvent(event);
        const canvas = document.getElementById('game-canvas');
        if (canvas) canvas.dispatchEvent(event);
    }

    async function launchGame(base64Rom, fileName) {
        try {
            console.log("Iniciando processamento da ROM...");

            if (nostalgistInstance) {
                try { await nostalgistInstance.exit(); } catch (e) {}
                nostalgistInstance = null;
            }

            // Otimização: Conversão mais rápida usando Uint8Array.from se possível, 
            // mas mantendo loop simples para compatibilidade
            const binaryString = atob(base64Rom);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const romFile = new File([bytes], fileName, { type: 'application/octet-stream' });
            const canvasElement = document.getElementById('game-canvas');

            // Configurações otimizadas para Nostalgist
            nostalgistInstance = await Nostalgist.launch({
                element: canvasElement,
                core: 'snes9x', 
                rom: romFile,
                resolveCoreJs: (core) => `/assets/cores/${core}_libretro.js`,
                resolveCoreWasm: (core) => `/assets/cores/${core}_libretro.wasm`,
                
                // Tenta forçar configurações de performance se disponível na versão
                run: {
                    fceux: {
                        hw_acceleration: true
                    }
                }
            });
            
            console.log("Emulador rodando!");

        } catch (e) {
            console.error(e);
            alert("Erro JS: " + e.message);
        }
    }
</script>

</body>
</html>
