<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNES Fullscreen Turbo</title>
    <style>
        /* CSS RESET TOTAL */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            position: fixed; /* Impede scroll elástico do Android */
        }

        /* CONFIGURAÇÃO PARA ESTICAR A TELA */
        canvas {
            display: block;
            width: 100vw !important;  /* Força largura total */
            height: 100vh !important; /* Força altura total */
            object-fit: fill;         /* Estica para preencher tudo (pode distorcer um pouco, mas preenche) */
            
            /* Performance Gráfica */
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* CONTADOR DE FPS EXTERNO */
        #fps-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #FFFF00; /* Amarelo */
            font-family: monospace;
            font-size: 20px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            pointer-events: none; /* O toque passa através dele */
            z-index: 9999;
        }
    </style>
    <script src="/assets/nostalgist.umd.js"></script>
</head>
<body>

<!-- Contador FPS Visível -->
<div id="fps-overlay">FPS: 0</div>

<!-- Canvas -->
<canvas id="game-canvas" tabindex="1"></canvas>

<script>
    let nostalgistInstance = null;
    const canvas = document.getElementById('game-canvas');
    const fpsElement = document.getElementById('fps-overlay');

    // --- SISTEMA DE FPS JAVASCRIPT ---
    let frameCount = 0;
    let lastTime = performance.now();
    function loopFPS() {
        const now = performance.now();
        frameCount++;
        if (now - lastTime >= 1000) {
            fpsElement.innerText = "FPS: " + frameCount;
            frameCount = 0;
            lastTime = now;
        }
        requestAnimationFrame(loopFPS);
    }
    requestAnimationFrame(loopFPS); // Inicia o contador

    // --- CONTROLES ---
    const keyMap = {
        'UP':    { code: 'ArrowUp',    key: 'ArrowUp',    keyCode: 38 },
        'DOWN':  { code: 'ArrowDown',  key: 'ArrowDown',  keyCode: 40 },
        'LEFT':  { code: 'ArrowLeft',  key: 'ArrowLeft',  keyCode: 37 },
        'RIGHT': { code: 'ArrowRight', key: 'ArrowRight', keyCode: 39 },
        'A':     { code: 'KeyX',       key: 'x',          keyCode: 88 },
        'B':     { code: 'KeyZ',       key: 'z',          keyCode: 90 },
        'X':     { code: 'KeyS',       key: 's',          keyCode: 83 },
        'Y':     { code: 'KeyA',       key: 'a',          keyCode: 65 },
        'START': { code: 'Enter',      key: 'Enter',      keyCode: 13 },
        'SELECT':{ code: 'ShiftRight', key: 'Shift',      keyCode: 16 }
    };

    function androidButtonEvent(btnName, isDown) {
        const mapping = keyMap[btnName];
        if (!mapping) return;
        if (document.activeElement !== canvas) canvas.focus();

        const eventName = isDown ? 'keydown' : 'keyup';
        const event = new KeyboardEvent(eventName, {
            bubbles: true, cancelable: true, view: window,
            key: mapping.key, code: mapping.code, keyCode: mapping.keyCode, which: mapping.keyCode,
        });
        canvas.dispatchEvent(event);
        window.dispatchEvent(event);
    }

    // --- INICIALIZAÇÃO OTIMIZADA ---
    async function launchGame(base64Rom, fileName) {
        try {
            if (nostalgistInstance) {
                await nostalgistInstance.exit();
                nostalgistInstance = null;
            }

            const binaryString = atob(base64Rom);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const romFile = new File([bytes], fileName);

            nostalgistInstance = await Nostalgist.launch({
                element: canvas,
                
                // PERFORMANCE: Use o core 2002.
                core: 'snes9x2002', 
                
                rom: romFile,
                resolveCoreJs: (core) => `/assets/cores/${core}_libretro.js`,
                resolveCoreWasm: (core) => `/assets/cores/${core}_libretro.wasm`,

                // CONFIGURAÇÃO DO RETROARCH (Tela Cheia + Velocidade)
                retroarchConfig: {
                    // CORREÇÃO TELA PEQUENA:
                    video_scale_integer: "false", // Permite escalar sem ser números inteiros
                    video_aspect_ratio_auto: "true", // Tenta preencher a tela
                    video_smooth: "false", // Pixels nítidos (melhora performance)
                    
                    // VELOCIDADE DE ÁUDIO (Evita engasgos)
                    audio_latency: "96", 
                    
                    // VELOCIDADE DE VÍDEO
                    video_vsync: "true",
                    video_threaded: "true"
                }
            });

            // Força o CSS novamente após o emulador carregar (pois ele tenta sobrescrever)
            setTimeout(() => {
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
                canvas.focus();
            }, 1000);

        } catch (e) {
            alert("Erro: " + e.message);
        }
    }
</script>
</body>
</html>
