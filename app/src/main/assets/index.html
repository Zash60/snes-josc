<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNES 2005 Pro</title>
    <style>
        /* RESET E TELA CHEIA */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body, html { width: 100%; height: 100%; background-color: #000; overflow: hidden; position: fixed; }
        
        /* CANVAS ESTICADO */
        canvas {
            display: block;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: fill;
            image-rendering: pixelated; /* Mantém pixels nítidos */
            image-rendering: crisp-edges;
        }

        /* FPS OVERLAY */
        #fps-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00FF00;
            font-family: monospace;
            font-size: 14px;
            font-weight: bold;
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 9998;
        }

        /* NOTIFICAÇÃO (Substitui o Alert) */
        #game-toast {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 9999;
            border: 1px solid #444;
        }
    </style>
    <script src="/assets/nostalgist.umd.js"></script>
</head>
<body>

<div id="fps-overlay">FPS: 0</div>
<div id="game-toast">Mensagem</div>
<canvas id="game-canvas" tabindex="1"></canvas>

<script>
    let nostalgistInstance = null;
    let memorySaveState = null; // Variável RAM para o Save
    
    const canvas = document.getElementById('game-canvas');
    const fpsElement = document.getElementById('fps-overlay');
    const toastElement = document.getElementById('game-toast');

    // --- SISTEMA DE NOTIFICAÇÃO (TOAST) ---
    let toastTimeout;
    function showToast(message, isError = false) {
        toastElement.innerText = message;
        toastElement.style.color = isError ? "#FF5555" : "#FFFFFF";
        toastElement.style.opacity = "1";
        
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toastElement.style.opacity = "0";
        }, 2000); // Some depois de 2 segundos
    }

    // --- FPS COUNTER ---
    let frameCount = 0;
    let lastTime = performance.now();
    function loopFPS() {
        const now = performance.now();
        frameCount++;
        if (now - lastTime >= 1000) {
            fpsElement.innerText = "FPS: " + frameCount;
            frameCount = 0;
            lastTime = now;
        }
        requestAnimationFrame(loopFPS);
    }
    requestAnimationFrame(loopFPS);

    // --- MAPA DE TECLAS (COM L e R) ---
    const keyMap = {
        'UP':    { code: 'ArrowUp',    key: 'ArrowUp',    keyCode: 38 },
        'DOWN':  { code: 'ArrowDown',  key: 'ArrowDown',  keyCode: 40 },
        'LEFT':  { code: 'ArrowLeft',  key: 'ArrowLeft',  keyCode: 37 },
        'RIGHT': { code: 'ArrowRight', key: 'ArrowRight', keyCode: 39 },
        'A':     { code: 'KeyX',       key: 'x',          keyCode: 88 },
        'B':     { code: 'KeyZ',       key: 'z',          keyCode: 90 },
        'X':     { code: 'KeyS',       key: 's',          keyCode: 83 },
        'Y':     { code: 'KeyA',       key: 'a',          keyCode: 65 },
        'L':     { code: 'KeyQ',       key: 'q',          keyCode: 81 }, // Mapeado para Q
        'R':     { code: 'KeyW',       key: 'w',          keyCode: 87 }, // Mapeado para W
        'START': { code: 'Enter',      key: 'Enter',      keyCode: 13 },
        'SELECT':{ code: 'ShiftRight', key: 'Shift',      keyCode: 16 }
    };

    function androidButtonEvent(btnName, isDown) {
        const mapping = keyMap[btnName];
        if (!mapping) return;
        
        if (document.activeElement !== canvas) canvas.focus();

        const eventName = isDown ? 'keydown' : 'keyup';
        const event = new KeyboardEvent(eventName, {
            bubbles: true, cancelable: true, view: window,
            key: mapping.key, code: mapping.code, keyCode: mapping.keyCode, which: mapping.keyCode,
        });
        canvas.dispatchEvent(event);
        window.dispatchEvent(event);
    }

    // --- SAVE / LOAD STATE (CORRIGIDO) ---
    async function triggerSaveState() {
        if (!nostalgistInstance) return showToast("Nenhum jogo rodando", true);
        try {
            // Salva o estado como um Blob
            const stateBlob = await nostalgistInstance.saveState();
            
            // Converte para um objeto File para garantir compatibilidade
            memorySaveState = new File([stateBlob], "state.sav");
            
            showToast("Estado Salvo!");
        } catch (e) {
            console.error(e);
            showToast("Erro ao Salvar", true);
        }
    }

    async function triggerLoadState() {
        if (!nostalgistInstance) return showToast("Nenhum jogo rodando", true);
        if (!memorySaveState) {
            return showToast("Nenhum Save Encontrado!", true);
        }
        try {
            // Carrega o arquivo File que criamos no save
            await nostalgistInstance.loadState(memorySaveState);
            showToast("Estado Carregado!");
        } catch (e) {
            console.error(e);
            // Mensagem técnica no console, mas simples na tela
            showToast("Erro ao carregar Save", true); 
        }
    }

    // --- INICIAR JOGO ---
    async function launchGame(base64Rom, fileName) {
        try {
            showToast("Carregando Core...");

            if (nostalgistInstance) {
                await nostalgistInstance.exit();
                nostalgistInstance = null;
                memorySaveState = null; // Reseta o save ao trocar de jogo
            }

            const binaryString = atob(base64Rom);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const romFile = new File([bytes], fileName);

            // CORE 2005 (Arquivos: snes9x2005_libretro.js / .wasm)
            nostalgistInstance = await Nostalgist.launch({
                element: canvas,
                core: 'snes9x2005', 
                rom: romFile,
                resolveCoreJs: (core) => `/assets/cores/${core}_libretro.js`,
                resolveCoreWasm: (core) => `/assets/cores/${core}_libretro.wasm`,

                retroarchConfig: {
                    video_scale_integer: "false",
                    video_aspect_ratio_auto: "true",
                    video_smooth: "false", 
                    
                    // Configurações para evitar travamentos
                    audio_latency: "96", 
                    video_vsync: "true",
                    video_threaded: "true"
                }
            });

            setTimeout(() => {
                canvas.focus();
                showToast("Jogo Iniciado!");
            }, 800);

        } catch (e) {
            console.error(e);
            showToast("Erro Fatal: " + e.message, true);
        }
    }
</script>
</body>
</html>
