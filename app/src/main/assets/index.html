<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNES Emulator Native FPS</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
        }
        canvas#game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Garante pixels nítidos (estilo Retro) */
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            outline: none;
        }
    </style>
    <!-- Carrega a biblioteca Nostalgist -->
    <script src="/assets/nostalgist.umd.js"></script>
</head>
<body>

<canvas id="game-canvas" tabindex="1"></canvas>

<script>
    let nostalgistInstance = null;
    const canvas = document.getElementById('game-canvas');

    // Mapeamento de Teclas (Padrão RetroArch)
    const keyMap = {
        'UP':    { code: 'ArrowUp',    key: 'ArrowUp',    keyCode: 38 },
        'DOWN':  { code: 'ArrowDown',  key: 'ArrowDown',  keyCode: 40 },
        'LEFT':  { code: 'ArrowLeft',  key: 'ArrowLeft',  keyCode: 37 },
        'RIGHT': { code: 'ArrowRight', key: 'ArrowRight', keyCode: 39 },
        'A':     { code: 'KeyX',       key: 'x',          keyCode: 88 },
        'B':     { code: 'KeyZ',       key: 'z',          keyCode: 90 },
        'X':     { code: 'KeyS',       key: 's',          keyCode: 83 },
        'Y':     { code: 'KeyA',       key: 'a',          keyCode: 65 },
        'START': { code: 'Enter',      key: 'Enter',      keyCode: 13 },
        'SELECT':{ code: 'ShiftRight', key: 'Shift',      keyCode: 16 }
    };

    // Função de Entrada Android -> JS
    function androidButtonEvent(btnName, isDown) {
        const mapping = keyMap[btnName];
        if (!mapping) return;

        // Garante Foco
        if (document.activeElement !== canvas) {
            canvas.focus();
        }

        const eventName = isDown ? 'keydown' : 'keyup';
        
        // Cria evento simulado completo
        const event = new KeyboardEvent(eventName, {
            bubbles: true,
            cancelable: true,
            view: window,
            key: mapping.key,
            code: mapping.code,
            keyCode: mapping.keyCode,
            which: mapping.keyCode,
        });

        // Dispara no Canvas e Window para compatibilidade
        canvas.dispatchEvent(event);
        window.dispatchEvent(event);
    }

    // Função de Inicialização
    async function launchGame(base64Rom, fileName) {
        try {
            // Limpa instância anterior se existir
            if (nostalgistInstance) {
                await nostalgistInstance.exit();
                nostalgistInstance = null;
            }

            console.log("Convertendo ROM...");
            // Decodifica Base64 para Array de Bytes
            const binaryString = atob(base64Rom);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const romFile = new File([bytes], fileName);

            console.log("Iniciando Nostalgist com snes9x2002...");

            // Inicia Emulador
            nostalgistInstance = await Nostalgist.launch({
                element: canvas,
                
                // CORE MAIS RÁPIDO (Baixar snes9x2002_libretro.js/.wasm)
                core: 'snes9x2002', 
                
                rom: romFile,
                resolveCoreJs: (core) => `/assets/cores/${core}_libretro.js`,
                resolveCoreWasm: (core) => `/assets/cores/${core}_libretro.wasm`,

                // CONFIGURAÇÃO INTERNA DO RETROARCH
                retroarchConfig: {
                    // Exibe o contador de FPS nativo do emulador (Texto Amarelo)
                    fps_show: "true",

                    // Configurações de Vídeo (Sem Skip Frame)
                    video_vsync: "true",          // Mantém sincronia vertical
                    video_threaded: "true",       // Tenta usar thread separada para vídeo
                    
                    // Configurações de Áudio (Baixa Latência)
                    audio_latency: "64",          // 64ms é um bom equilíbrio
                    audio_sync: "true",           // Sincroniza emulação com áudio
                }
            });
            
            // Foco final
            setTimeout(() => {
                canvas.focus();
                console.log("Emulador pronto.");
            }, 500);

        } catch (e) {
            console.error("Erro Fatal:", e);
            alert("Erro: " + e.message + "\n\nVerifique se os arquivos 'snes9x2002_libretro' (.js e .wasm) estão na pasta assets/cores/.");
        }
    }
</script>
</body>
</html>
